{% extends "base.html" %}
{% block nav_jobs %}active{% endblock %}
{% load static %}

{% block content %}
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title"><i class="fas fa-briefcase"></i> Find Your Dream Job</h1>
        <p class="page-subtitle">Discover amazing opportunities from top companies</p>
        <div class="my-applications-btn-container">
        <a href="{% url 'applications:view_applications' %}" class="my-applications-btn">My Applications</a>
        </div>
    </div>

    <!-- Search & Filter Form -->
    <form method="get" action="" class="filter-form">
        <input type="text" 
            name="search" 
            placeholder="Search by job title or company..." 
            value="{{ request.GET.search }}">

        <!-- Google Maps Autocomplete location input -->
        <input id="location-input"
            type="text" 
            name="location" 
            placeholder="Search by location..." 
            value="{{ request.GET.location }}">

        <!-- Hidden fields for lat/lng -->
        <input type="hidden" id="lat-input" name="lat" value="{{ request.GET.lat }}">
        <input type="hidden" id="lng-input" name="lng" value="{{ request.GET.lng }}">

        <!-- Numeric radius input -->
        <input type="number" 
            name="radius" 
            placeholder="Radius in miles" 
            min="1" 
            value="{{ request.GET.radius }}">

        <select name="pay_type">
            <option value="all">All Pay Types</option>
            <option value="annual" {% if request.GET.pay_type == "annual" %}selected{% endif %}>Annual</option>
            <option value="monthly" {% if request.GET.pay_type == "monthly" %}selected{% endif %}>Monthly</option>
            <option value="hourly" {% if request.GET.pay_type == "hourly" %}selected{% endif %}>Hourly</option>
        </select>

        <input type="number" 
            name="min_salary" 
            placeholder="Min salary" 
            value="{{ request.GET.min_salary }}">
        
        <input type="number" 
            name="max_salary" 
            placeholder="Max salary" 
            value="{{ request.GET.max_salary }}">

        <button type="submit" class="search-btn">
            <i class="fas fa-search"></i>
            Search Jobs
        </button>

        <div class="dropdown-checklist">
            <div class="dropdown-header" onclick="toggleDropdown()">
                <i class="fas fa-tools"></i> Filter by Skills
                <span class="arrow">&#9662;</span>
            </div>
            <div id="skillsDropdown" class="dropdown-list" style="display: none;">
                {% for skill in all_skills %}
                <label class="dropdown-item">
                    <input type="checkbox" name="skills" value="{{ skill.name }}"
                        {% if skill.name in selected_skills %}checked{% endif %}>
                    {{ skill.name }}
                </label>
                {% endfor %}
            </div>
        </div>
    </form>

    <!-- Results Header -->
    <div class="results-header">
        <div class="results-count">
            <i class="fas fa-list"></i>
            {{ jobs|length }} job{{ jobs|length|pluralize }} found
        </div>
        <div class="sort-options">
            <select onchange="this.form.submit()" name="sort">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="salary_high">Highest Salary</option>
                <option value="salary_low">Lowest Salary</option>
            </select>
        </div>
    </div>

    <!-- Interactive Map -->
    <div id="map" style="width: 100%; height: 400px; margin: 20px 0; border-radius: 8px;"></div>

    <!-- Job Listings -->
    <div class="jobs-list">
        {% for job in jobs %}
            <div class="job-card" data-job-id="{{ job.id }}">
                <div class="job-card-info">
                    <h2 class="job-title">{{ job.name }}</h2>
                    <h3 class="company-name">{{ job.company }}</h3>
                    
                    <div class="job-details">
                        <div class="job-detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ job.location }}</span>
                        </div>
                        {% if job.distance %}
                        <div class="job-detail-item">
                            <i class="fas fa-road"></i>
                            <span>{{ job.distance }} miles away</span>
                        </div>
                        {% endif %}
                        <div class="job-detail-item">
                            <i class="fas fa-clock"></i>
                            <span>{{ job.get_pay_type_display }}</span>
                        </div>
                        <div class="job-detail-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Posted recently</span>
                        </div>
                    </div>
                    
                    <div class="job-salary">
                        <i class="fas fa-dollar-sign"></i>
                        ${{ job.pay_min }} â€“ ${{ job.pay_max }} 
                        <span style="font-weight: normal; color: #718096;">({{ job.get_pay_type_display }})</span>
                    </div>
                </div>
                
                <div class="job-card-actions">
                    <a href="{% url 'jobs:show' job.id %}" class="apply-btn">
                        <i class="fas fa-eye"></i>
                        View Details
                    </a>
                    <a href="#" class="save-btn">
                        <i class="fas fa-heart"></i>
                        Save Job
                    </a>
                </div>
            </div>
        {% empty %}
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>No Jobs Found</h3>
                <p>No jobs found matching your criteria. Try adjusting your search filters.</p>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Google Maps API + Autocomplete -->
<script>
  const jobMarkers = JSON.parse('{{ job_markers_json|escapejs }}');
  let map;

  window.initAutocomplete = function () {
    const input = document.getElementById("location-input");
    const autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.setFields(["geometry", "formatted_address"]);

    autocomplete.addListener("place_changed", function () {
      const place = autocomplete.getPlace();
      if (place && place.geometry) {
        document.getElementById("lat-input").value = place.geometry.location.lat();
        document.getElementById("lng-input").value = place.geometry.location.lng();
        if (map) {
          map.setCenter(place.geometry.location);
          map.setZoom(12);
        }
      }
    });

    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 4,
      center: { lat: 39.8283, lng: -98.5795 }
    });

    const bounds = new google.maps.LatLngBounds();

    jobMarkers.forEach((md) => {
      const pos = { lat: md.lat, lng: md.lng };
      const marker = new google.maps.Marker({
        position: pos,
        map: map,
        title: `${md.title} - ${md.company}`
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `<div style="font-size:14px;">
                    <strong>${md.title}</strong><br>
                    ${md.company}<br>
                    ${md.location}
                  </div>`
      });

      marker.addListener("click", () => {
        infoWindow.open(map, marker);
        highlightJobCard(md.id);
      });

      bounds.extend(pos);
    });

    if (jobMarkers.length > 0) {
      map.fitBounds(bounds);
    }
  };

  function highlightJobCard(jobId) {
    document.querySelectorAll(".job-card.highlighted").forEach(el => el.classList.remove("highlighted"));
    const card = document.querySelector(`.job-card[data-job-id="${jobId}"]`);
    if (card) {
      card.classList.add("highlighted");
      card.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }

  function toggleDropdown() {
    const dropdown = document.getElementById("skillsDropdown");
    dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
  }
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initAutocomplete"
  async defer>
</script>
{% endblock %}

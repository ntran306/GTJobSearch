{% extends "base.html" %}
{% block nav_jobs %}active{% endblock %}
{% load static %}

{% block content %}
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title"><i class="fas fa-briefcase"></i> Find Your Dream Job</h1>
        <p class="page-subtitle">Discover amazing opportunities from top companies</p>
        <div class="my-applications-btn-container">
        <a href="{% url 'applications:view_applications' %}" class="my-applications-btn">My Applications</a>
        </div>
    </div>

    <!-- Search & Filter Form -->
    <form method="get" action="" class="filter-form">
        <input type="text" 
            name="search" 
            placeholder="Search by job title or company..." 
            value="{{ request.GET.search }}">

        <!-- Google Maps Autocomplete location input -->
        <input id="location-input"
            type="text" 
            name="location" 
            placeholder="Search by location..." 
            value="{{ request.GET.location }}">

        <!-- Hidden fields for lat/lng -->
        <input type="hidden" id="lat-input" name="lat" value="{{ request.GET.lat }}">
        <input type="hidden" id="lng-input" name="lng" value="{{ request.GET.lng }}">

        <!-- Numeric radius input -->
        <input type="number" 
            name="radius" 
            placeholder="Radius in miles" 
            min="1" 
            value="{{ request.GET.radius }}">

        <select name="pay_type">
            <option value="all">All Pay Types</option>
            <option value="annual" {% if request.GET.pay_type == "annual" %}selected{% endif %}>Annual</option>
            <option value="monthly" {% if request.GET.pay_type == "monthly" %}selected{% endif %}>Monthly</option>
            <option value="hourly" {% if request.GET.pay_type == "hourly" %}selected{% endif %}>Hourly</option>
        </select>

        <input type="number" 
            name="min_salary" 
            placeholder="Min salary" 
            value="{{ request.GET.min_salary }}">
        
        <input type="number" 
            name="max_salary" 
            placeholder="Max salary" 
            value="{{ request.GET.max_salary }}">

        <!-- Visa Sponsorship Filter -->
        <label style="margin-left: 10px;">
            <input type="checkbox" name="visa" {% if request.GET.visa %}checked{% endif %}>
            Visa Sponsorship
        </label>

        <div class="dropdown-checklist">
            <div class="dropdown-header" onclick="toggleDropdown()">
                <i class="fas fa-tools"></i> Filter by Skills
                <span class="arrow">&#9662;</span>
            </div>
            <div id="skillsDropdown" class="dropdown-list" style="display: none;">
                {% for skill in all_skills %}
                <label class="dropdown-item">
                    <input type="checkbox" name="skills" value="{{ skill.name }}"
                        {% if skill.name in selected_skills %}checked{% endif %}>
                    {{ skill.name }}
                </label>
                {% endfor %}
            </div>
        </div>

        <button type="submit" class="search-btn">
            <i class="fas fa-search"></i>
            Search Jobs
        </button>
    </form>

    <!-- Results Header -->
    <div class="results-header">
        <div class="results-count">
            <i class="fas fa-list"></i>
            {{ jobs|length }} job{{ jobs|length|pluralize }} found
        </div>
        <div class="sort-options">
            <select onchange="this.form.submit()" name="sort">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="salary_high">Highest Salary</option>
                <option value="salary_low">Lowest Salary</option>
            </select>
        </div>
    </div>

    <!-- Interactive Map -->
    <div id="map" style="width: 100%; height: 400px; margin: 20px 0; border-radius: 8px;"></div>

    <!-- Job Listings -->
    <div class="jobs-list">
        {% for job in jobs %}
            <div class="job-card" data-job-id="{{ job.id }}">
                <div class="job-card-info">
                    <h2 class="job-title">{{ job.title }}</h2>
                    <h3 class="company-name">{{ job.company }}</h3>
                    
                    <div class="job-details">
                        <div class="job-detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ job.location }}</span>
                        </div>
                        {% if job.road_miles %}
                        <div class="job-detail-item">
                            <i class="fas fa-road"></i>
                            <span>{{ job.road_miles }} miles</span>
                        </div>
                        {% endif %}
                        {% if job.drive_minutes %}
                        <div class="job-detail-item">
                            <i class="fas fa-car"></i>
                            <span>~{{ job.drive_minutes }} min drive</span>
                        </div>
                        {% endif %}
                        <div class="job-detail-item">
                            <i class="fas fa-clock"></i>
                            <span>{{ job.get_pay_type_display }}</span>
                        </div>
                        <div class="job-detail-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Posted recently</span>
                        </div>
                    </div>
                    
                    <div class="job-salary">
                        <i class="fas fa-dollar-sign"></i>
                        ${{ job.pay_min }} – ${{ job.pay_max }} 
                        <span style="font-weight: normal; color: #718096;">({{ job.get_pay_type_display }})</span>
                    </div>
                </div>
                
                <div class="job-card-actions">
                    <a href="{% url 'jobs:show' job.id %}" class="apply-btn">
                        <i class="fas fa-eye"></i>
                        View Details
                    </a>
                    <a href="#" class="save-btn">
                        <i class="fas fa-heart"></i>
                        Save Job
                    </a>
                </div>
            </div>
        {% empty %}
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>No Jobs Found</h3>
                <p>No jobs found matching your criteria. Try adjusting your search filters.</p>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Map + pins with same-location dropdown; draw route on pin click; 'More details' only scrolls -->
<script>
  /* Data from Django */
  const jobMarkers = JSON.parse('{{ job_markers_json|escapejs }}');
  const detailUrlTemplate = "{% url 'jobs:show' 0 %}"; // we'll replace 0 with the real id

  /* Globals */
  let map, infoWindow, directionsService, directionsRenderer;

  /* Helper: consistent key for exact same lat/lng */
  function locKey(lat, lng) {
    return `${Number(lat).toFixed(6)},${Number(lng).toFixed(6)}`;
  }

  /* Group jobs by exact coordinates */
  const jobsByLocation = (() => {
    const dict = {};
    jobMarkers.forEach(j => {
      const key = locKey(j.lat, j.lng);
      (dict[key] ||= []).push(j);
    });
    return dict;
  })();

  /* Draw route from origin (hidden inputs) to destination */
  function drawRouteTo(destLat, destLng) {
    const originLat = parseFloat(document.getElementById("lat-input").value);
    const originLng = parseFloat(document.getElementById("lng-input").value);

    if (Number.isNaN(originLat) || Number.isNaN(originLng)) {
      // No origin yet: don't block the user with an alert; just skip drawing
      console.warn("No origin set. Use the location box to set an origin for routing.");
      return;
    }

    directionsService.route(
      {
        origin: { lat: originLat, lng: originLng },
        destination: { lat: destLat, lng: destLng },
        travelMode: google.maps.TravelMode.DRIVING,
        provideRouteAlternatives: false
      },
      (result, status) => {
        if (status === "OK" || status === google.maps.DirectionsStatus.OK) {
          directionsRenderer.setDirections(result);
          const bounds = new google.maps.LatLngBounds();
          result.routes[0].overview_path.forEach(p => bounds.extend(p));
          map.fitBounds(bounds);
        } else {
          console.warn("Directions request failed:", status);
        }
      }
    );
  }

  /* Highlight a job card (only when user clicks 'More details') */
  function highlightJobCard(jobId) {
    document.querySelectorAll(".job-card.highlighted").forEach(el => el.classList.remove("highlighted"));
    const card = document.querySelector(`.job-card[data-job-id="${jobId}"]`);
    if (card) {
      card.classList.add("highlighted");
      card.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }

  /* Skills dropdown toggle (kept as-is) */
  function toggleDropdown() {
    const dropdown = document.getElementById("skillsDropdown");
    dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
  }

  /* Simple HTML escape */
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;").replace(/</g, "&lt;")
      .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  /* Build InfoWindow content: dropdown + compact 'More details' link BELOW it */
  function buildInfoContent(primaryJob, jobsAtLoc) {
    const selectId = `jobsAt_${primaryJob.id}`;
    const linkId = `moreBtn_${primaryJob.id}`;
    const options = jobsAtLoc
      .map(j => `<option value="${j.id}">${escapeHtml(j.title)} — ${escapeHtml(j.company)}</option>`)
      .join("");

    return `
      <div style="font-size:14px; max-width:260px;">
        <strong>${escapeHtml(primaryJob.title)}</strong><br/>
        ${escapeHtml(primaryJob.company)}<br/>
        ${escapeHtml(primaryJob.location)}<br/>

        <div style="margin-top:8px;">
          <label style="font-weight:600; display:block; margin-bottom:6px;">Other jobs here</label>
          <select id="${selectId}" style="width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:8px;">
            ${options}
          </select>

          <!-- Compact 'More details' link underneath for clarity -->
          <a id="${linkId}"
             href="#"
             class="apply-btn"
             style="margin-top:8px; display:block; width:100%; text-align:center; padding:0.5rem 0.75rem; font-size:0.9rem; text-decoration:none;">
             More details
          </a>
        </div>
      </div>
    `;
  }

  /* Combined init (Autocomplete + Map + Markers) */
  window.initAutocomplete = function () {
    // Places Autocomplete
    const input = document.getElementById("location-input");
    const autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.setFields(["geometry", "formatted_address"]);
    autocomplete.addListener("place_changed", function () {
      const place = autocomplete.getPlace();
      if (place && place.geometry) {
        document.getElementById("lat-input").value = place.geometry.location.lat();
        document.getElementById("lng-input").value = place.geometry.location.lng();
        if (map) {
          map.setCenter(place.geometry.location);
          map.setZoom(12);
        }
      }
    });

    // Map + Directions services
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 4,
      center: { lat: 39.8283, lng: -98.5795 }
    });
    infoWindow = new google.maps.InfoWindow();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: false,
      preserveViewport: true
    });
    directionsRenderer.setMap(map);

    const bounds = new google.maps.LatLngBounds();

    // Markers & click behavior
    jobMarkers.forEach((md) => {
      const pos = { lat: md.lat, lng: md.lng };
      const marker = new google.maps.Marker({
        position: pos,
        map: map,
        title: `${md.title} - ${md.company}`
      });

      marker.addListener("click", () => {
        // Route immediately from origin to this pin
        drawRouteTo(md.lat, md.lng);

        // Show dropdown + 'More details' (but do NOT auto-scroll/highlight)
        const key = locKey(md.lat, md.lng);
        const group = jobsByLocation[key] || [md];
        infoWindow.setContent(buildInfoContent(md, group));
        infoWindow.open(map, marker);

        // Wire dropdown + link
        google.maps.event.addListenerOnce(infoWindow, "domready", () => {
          const selectEl = document.getElementById(`jobsAt_${md.id}`);
          const linkEl = document.getElementById(`moreBtn_${md.id}`);

          // Track selected job id (starts as the clicked one)
          let selectedId = String(md.id);
          selectEl.addEventListener("change", (e) => { selectedId = e.target.value; });

          linkEl.addEventListener("click", (e) => {
            e.preventDefault();
            // Update href and then highlight/scroll the card
            linkEl.href = detailUrlTemplate.replace("/0/", `/${selectedId}/`);
            highlightJobCard(selectedId);
            // Optional: close info window after click
            // infoWindow.close();
          });
        });
      });

      bounds.extend(pos);
    });

    if (jobMarkers.length > 0) {
      map.fitBounds(bounds);
    }
  };
</script>

<!-- Google Maps API + Autocomplete loader -->
<script
  src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initAutocomplete"
  async defer>
</script>
{% endblock content %}

{% extends "base.html" %}
{% block nav_applications %}active{% endblock %}

{% load static %}

{% block content %}

<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title"><i class="fas fa-clipboard-list"></i> Application Tracker</h1>
        <p class="page-subtitle">Track and manage all your job applications in one place</p>
    </div>

    {% if applications %}
        <!-- Applications Table -->
        <div class="applications-container">
            <div class="container-header">
                <h2><i class="fas fa-list"></i> Your Applications</h2>
                <span style="opacity: 0.9;">{{ applications|length }} application{{ applications|length|pluralize }}</span>
            </div>

            <table class="applications-table">
                <thead>
                    <tr>
                        <th>Job Title</th>
                        <th>Company</th>
                        <th>Status</th>
                        <th>Applied On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for app in applications %}
                        <tr>
                            <td><a href="{% url 'jobs:show' app.job.id %}">{{ app.job.title }}</a></td>
                            <td>{{ app.job.company }}</td>
                            <td><span class="status-badge status-{{ app.status }}"><i class="fas fa-circle"></i> {{ app.get_status_display }}</span></td>
                            <td>{{ app.created_at|date:"M d, Y" }}</td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'applications:update_status' app.id %}" class="update-btn">
                                        <i class="fas fa-edit"></i> Update Status
                                    </a>
                                    <a href="{% url 'jobs:show' app.job.id %}" class="view-btn">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Recommended Jobs Section -->
        <div class="recommended-jobs-section">
            <div class="section-header">
                <h2><i class="fas fa-lightbulb"></i> Recommended Jobs for You</h2>
                {% if user_skills %}
                    <p class="section-subtitle">Based on your skills: {{ user_skills|join:", " }}</p>
                {% else %}
                    <p class="section-subtitle">No recommended jobs because you have no skills listed.</p>
                {% endif %}
            </div>

            {% if recommended_jobs %}
                <div class="recommended-jobs-grid">
                    {% for job in recommended_jobs %}
                        <div class="recommended-job-card">
                            <div class="job-card-header">
                                <h3>{{ job.title }}</h3>
                                <p>{{ job.company }}</p>
                            </div>
                            <div class="job-details">
                                <div><i class="fas fa-map-marker-alt"></i> {{ job.location }}</div>
                                <div><i class="fas fa-dollar-sign"></i> ${{ job.pay_min }} - ${{ job.pay_max }}</div>
                            </div>
                            <div class="job-skills">
                                {% for skill in job.required_skills.all|slice:":3" %}
                                    <span class="skill-match">{{ skill.name }}</span>
                                {% endfor %}
                                {% if job.required_skills.count > 3 %}
                                    <span class="skill-more">+{{ job.required_skills.count|add:"-3" }} more</span>
                                {% endif %}
                            </div>
                            <div class="job-actions">
                                <a href="{% url 'jobs:show' job.id %}" class="view-job-btn">
                                    <i class="fas fa-eye"></i> View Job
                                </a>
                                <button class="quick-apply-btn" onclick="showApplicationNote('{{ job.id }}')">
                                    <i class="fas fa-paper-plane"></i> Quick Apply
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    {% else %}
        <!-- No Applications -->
        <div class="no-applications">
            <i class="fas fa-clipboard-list"></i>
            <h3>No Applications Yet</h3>
            <p>Start applying for jobs to track your application progress here.</p>
            <a href="{% url 'jobs:index' %}" class="browse-jobs-btn">
                <i class="fas fa-search"></i> Browse Jobs
            </a>
        </div>
    {% endif %}
</div>

<!-- Application Modal -->
<div id="applicationModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>Write a personalized note for your application</h3>
        <textarea id="applicationNote" rows="5" placeholder="Type your message here..."></textarea>
        <br>
        <button onclick="submitApplication()">Submit</button>
    </div>
</div>

<script>
let currentJobId = null;

function showApplicationNote(jobId) {
    currentJobId = jobId;
    document.getElementById('applicationModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('applicationModal').style.display = 'none';
    document.getElementById('applicationNote').value = "";
}

function submitApplication() {
    const note = document.getElementById('applicationNote').value;
    console.log("Note for job", currentJobId, ":", note);

    // Redirect to apply URL
    window.location.href = `/applications/apply/${currentJobId}/`;

    closeModal();
}
</script>
{% endblock %}

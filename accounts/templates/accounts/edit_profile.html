{% extends "base.html" %}
{% load static %}

{% block nav_profile %}active{% endblock %}
{% block title %}Edit Profile | GT Job Search{% endblock %}

{% block content %}
<div class="container profile-page">
  <form method="post" enctype="multipart/form-data" class="edit-profile-form">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="form-errors">
        <p>Please correct the errors below:</p>
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <!-- ==================== PROFILE HEADER ==================== -->
    <section class="profile-card profile-header">
      <style>
        /* Hide the raw file input so only the Change Photo button shows */
        .avatar-input input[type="file"] {
          display: none;
        }
      </style>

      <div class="profile-avatar centered-avatar">
        <div class="avatar-placeholder">
          {% if profile.profile_picture %}
            <img src="{{ profile.profile_picture.url }}"
                 alt="{{ user.username }}'s avatar"
                 class="avatar-img"
                 id="avatarPreview">
          {% else %}
            {# Use a default placeholder image so JS always has an <img> to target #}
            <img src="{% static 'img/default-avatar.png' %}"
                 alt="Default avatar"
                 class="avatar-img"
                 id="avatarPreview">
          {% endif %}
        </div>

        {% if form.profile_picture %}
          <div class="avatar-input">
          <!-- Visible button -->
          <label for="{{ form.profile_picture.id_for_label }}" class="btn btn-outline btn-sm">
              Change Photo
          </label>

          <!-- Django raw file input (hidden visually) -->
          {{ form.profile_picture }}

          {% if form.profile_picture.errors %}
            <span class="error-message">{{ form.profile_picture.errors|striptags }}</span>
          {% endif %}

          <!-- Hide Django's "Currently: file.jpg" text + Clear checkbox -->
          <style>
              /* Hide the ugly 'Currently: file.jpg' Django output */
              .avatar-input a,
              .avatar-input .clearable-file-input,
              .avatar-input p {
                  display: none !important;
              }

              /* Keep actual file input hidden */
              .avatar-input input[type="file"] {
                  display: none !important;
              }
          </style>
      </div>
        {% endif %}
      </div>

      <div class="profile-info">
        <h1 class="profile-name">Edit Profile</h1>
        <p class="text-sm text-gray-600">Update your details below</p>
      </div>
    </section>

    <!-- ==================== HEADLINE ==================== -->
    {% if form.headline %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-user-tag"></i> Headline</h2>
      </div>
      <div class="section-content">
        <div class="form-group">
          {{ form.headline.label_tag }}
          {{ form.headline }}
          {% if form.headline.errors %}<span class="error-message">{{ form.headline.errors|striptags }}</span>{% endif %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- ==================== SKILLS ==================== -->
    {% if form.skills %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-tools"></i> Skills</h2>
      </div>
      <div class="section-content">
        <div class="form-group">
          {{ form.skills.label_tag }}

          <!-- Search + Add row -->
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <div style="flex: 1; position: relative;">
              <input type="text"
                     id="skillSearch"
                     placeholder="Search for skills..."
                     autocomplete="off"
                     style="width: 100%; padding: 0.875rem 2.5rem 0.875rem 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: #f7fafc;">
              <i class="fas fa-search"
                 style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
            </div>

            <!-- Same yellow gradient button as signup -->
            <button type="button" id="addSkillBtn" class="add-skill-btn">
              <i class="fas fa-plus"></i>
              <span>Add</span>
            </button>
          </div>

          <!-- Dropdown results -->
          <div id="skillDropdown"
               style="display: none; max-height: 200px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 12px; background: white; margin-bottom: 0.5rem;">
          </div>

          <!-- Selected skills chips -->
          <div id="selectedSkills"
               style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; min-height: 40px; padding: 0.5rem; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px;">
          </div>

          <!-- Hidden field that actually gets submitted -->
          <input type="hidden" name="skills" id="skillsInput" value="">

          {% if form.skills.errors %}
            <span class="error-message">{{ form.skills.errors|striptags }}</span>
          {% endif %}
          {% if form.skills.help_text %}
            <span class="help-text">{{ form.skills.help_text }}</span>
          {% endif %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- ==================== EDUCATION ==================== -->
    {% if form.education %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-graduation-cap"></i> Education</h2>
      </div>
      <div class="section-content">
        <div class="form-group">
          {{ form.education.label_tag }}
          {{ form.education }}
          {% if form.education.errors %}<span class="error-message">{{ form.education.errors|striptags }}</span>{% endif %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- ==================== WORK EXPERIENCE ==================== -->
    {% if form.work_experience %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-briefcase"></i> Work Experience</h2>
      </div>
      <div class="section-content">
        <div class="form-group">
          {{ form.work_experience.label_tag }}
          {{ form.work_experience }}
          {% if form.work_experience.errors %}<span class="error-message">{{ form.work_experience.errors|striptags }}</span>{% endif %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- ==================== LOCATION ==================== -->
    {% if form.location %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-map-marker-alt"></i> Location</h2>
      </div>
      <div class="section-content">
        <div class="form-group">
          {{ form.location.label_tag }}
          {{ form.location }}
          {% if form.location.errors %}<span class="error-message">{{ form.location.errors|striptags }}</span>{% endif %}
          {% if form.location.help_text %}<span class="help-text">{{ form.location.help_text }}</span>{% endif %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- ==================== PROJECTS ==================== -->
    {% if form.projects %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-project-diagram"></i> Projects</h2>
      </div>
      <div class="section-content">
        <div class="form-group">
          {{ form.projects.label_tag }}
          {{ form.projects }}
          {% if form.projects.errors %}<span class="error-message">{{ form.projects.errors|striptags }}</span>{% endif %}
          {% if form.projects.help_text %}<span class="help-text">{{ form.projects.help_text }}</span>{% endif %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- ==================== LINKS ==================== -->
    {% if form.links %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-link"></i> Links</h2>
      </div>
      <div class="section-content">
        <div class="form-group">
          {{ form.links.label_tag }}
          {{ form.links }}
          {% if form.links.errors %}<span class="error-message">{{ form.links.errors|striptags }}</span>{% endif %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- ==================== SAVE / CANCEL ==================== -->
    <div class="form-actions" style="margin: 1.25rem 0%;">
      <button type="submit" class="btn btn-primary">Save Changes</button>
      <a href="{% url 'accounts:profile' %}" class="btn btn-outline">Cancel</a>
    </div>

  </form>
</div>

{% if skills %}
  {{ skills|json_script:"available-skills" }}
  {{ selected_skills|json_script:"selected-skills" }}

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // ===== Avatar preview (existing code) =====
    const fileInput = document.getElementById("{{ form.profile_picture.id_for_label }}");
    const previewImg = document.getElementById("avatarPreview");

    if (fileInput && previewImg) {
        fileInput.addEventListener("change", () => {
            const file = fileInput.files[0];
            if (!file) return;

            if (!file.type.startsWith("image/")) {
                alert("Please select a valid image file.");
                fileInput.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // ===== Skills widget (same behavior as signup) =====
    const availableNode = document.getElementById('available-skills');
    const selectedNode  = document.getElementById('selected-skills');

    if (!availableNode || !selectedNode) return;  // safety net

    const availableSkills = JSON.parse(availableNode.textContent);
    let selectedSkills    = JSON.parse(selectedNode.textContent);

    const skillSearch      = document.getElementById('skillSearch');
    const skillDropdown    = document.getElementById('skillDropdown');
    const selectedSkillsDiv= document.getElementById('selectedSkills');
    const skillsInput      = document.getElementById('skillsInput');
    const addSkillBtn      = document.getElementById('addSkillBtn');

    function filterSkills(searchText) {
        const filtered = availableSkills.filter(skill =>
            skill.name.toLowerCase().includes(searchText.toLowerCase()) &&
            !selectedSkills.find(s => s.id === skill.id)
        );
        skillDropdown.innerHTML = filtered.map(skill =>
            `<div class="skill-option" data-id="${skill.id}" data-name="${skill.name}">${skill.name}</div>`
        ).join('');
        skillDropdown.style.display = filtered.length ? 'block' : 'none';
    }

    function addSkill(id, name) {
        if (!selectedSkills.find(s => s.id === id)) {
            selectedSkills.push({ id, name });
            renderSelectedSkills();
            updateHiddenInput();
        }
        if (skillSearch) skillSearch.value = '';
        skillDropdown.style.display = 'none';
    }

    function removeSkill(id) {
        selectedSkills = selectedSkills.filter(s => s.id !== id);
        renderSelectedSkills();
        updateHiddenInput();
    }

    function renderSelectedSkills() {
        if (!selectedSkills.length) {
            selectedSkillsDiv.innerHTML = '<span style="color: var(--gray-400);">No skills selected yet</span>';
            return;
        }
        selectedSkillsDiv.innerHTML = selectedSkills.map(skill =>
            `<span class="skill-tag" style="display:inline-flex;align-items:center;gap:0.5rem; padding: 0.35rem 0.7rem; border-radius: 999px; background: #FFF7E0; border: 1px solid #FACC15; font-size: 0.9rem;">
                ${skill.name}
                <button type="button"
                        onclick="removeSkill(${skill.id})"
                        style="background:none;border:none;color:#B45309;font-weight:bold;cursor:pointer;line-height:1;">
                    Ã—
                </button>
            </span>`
        ).join('');
    }

    function updateHiddenInput() {
        skillsInput.value = selectedSkills.map(s => s.id).join(',');
    }

    // expose removeSkill for inline onclick
    window.removeSkill = removeSkill;

    // Events
    if (skillSearch) {
        skillSearch.addEventListener('input', e => filterSkills(e.target.value));
    }

    if (skillDropdown) {
        skillDropdown.addEventListener('click', e => {
            if (e.target.classList.contains('skill-option')) {
                addSkill(parseInt(e.target.dataset.id), e.target.dataset.name);
            }
        });
    }

    if (addSkillBtn && skillSearch) {
        addSkillBtn.addEventListener('click', async () => {
            const skillName = skillSearch.value.trim();
            if (!skillName) return alert('Enter a skill name first');

            const existingSkill = availableSkills.find(
                s => s.name.toLowerCase() === skillName.toLowerCase()
            );
            if (existingSkill) return addSkill(existingSkill.id, existingSkill.name);

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            try {
                const res = await fetch('/accounts/api/skills/create/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify({ name: skillName })
                });
                if (res.ok) {
                    const data = await res.json();
                    availableSkills.push({ id: data.id, name: data.name });
                    addSkill(data.id, data.name);
                } else {
                    alert('Failed to add skill.');
                }
            } catch (err) {
                console.error('Error adding skill:', err);
            }
        });
    }

    document.addEventListener('click', e => {
        if (skillSearch && skillDropdown &&
            !skillSearch.contains(e.target) &&
            !skillDropdown.contains(e.target)) {
            skillDropdown.style.display = 'none';
        }
    });

    // initialize from server
    renderSelectedSkills();
    updateHiddenInput();
  });
  </script>

  <style>
  .add-skill-btn {
      padding: 0.75rem 1.25rem;
      background: linear-gradient(135deg, #FFE082 0%, #FFC107 40%, #FFB300 100%);
      color: #111827;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.45rem;
      transition: opacity 0.2s;
  }

  .add-skill-btn:hover {
      opacity: 0.9;
  }

  .skill-option {
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--gray-100);
      color: var(--gray-800);
  }
  .skill-option:hover {
      background: var(--primary-50);
      color: var(--gray-900);
  }
  .skill-option:last-child { border-bottom: none; }
  </style>
{% endif %}
{% endblock %}
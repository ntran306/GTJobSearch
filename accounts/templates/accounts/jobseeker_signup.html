{% load static %}
<head>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>BuzzedIn | Sign Up</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/favicon-16x16.png' %}">
</head>

<div class="signin-container">
    <div class="signin-card">
        <div class="signin-header">
            <h1><i class="fas fa-user"></i> BuzzedIn Sign Up</h1>
            <p>Create your account and start your job search journey</p>
        </div>

        <form method="POST" class="professional-form">
            {% csrf_token %}

            <!-- Username -->
            <div class="form-group">
                <label class="form-label" for="id_username">Username *</label>
                {{ form.username }}
                {% for error in form.username.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>

            <!-- Email -->
            <div class="form-group">
                <label class="form-label" for="id_email">Email *</label>
                {{ form.email }}
                {% for error in form.email.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>

            <!-- Password -->
            <div class="form-group">
                <label class="form-label" for="id_password1">Password *</label>
                {{ form.password1 }}
                {% for error in form.password1.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>

            <!-- Confirm Password -->
            <div class="form-group">
                <label class="form-label" for="id_password2">Confirm Password *</label>
                {{ form.password2 }}
                {% for error in form.password2.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>

            <!-- Headline -->
            <div class="form-group">
                <label class="form-label" for="id_headline">Professional Headline *</label>
                {{ form.headline }}
                {% for error in form.headline.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
                <small class="help-text">e.g., "Frontend Developer with 3+ years experience"</small>
            </div>

            <!-- ✅ Skills (Searchable Dropdown) -->
            <div class="form-group">
                <label class="form-label" for="skillSearch">Skills *</label>

                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div style="flex: 1; position: relative;">
                        <input type="text" id="skillSearch" placeholder="Search for skills..." autocomplete="off"
                            style="width: 100%; padding: 0.875rem 2.5rem 0.875rem 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: #f7fafc;">
                        <i class="fas fa-search"
                            style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
                    </div>
                    <button type="button" id="addSkillBtn"
                        style="padding: 0.875rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>

                <div id="skillDropdown"
                    style="display: none; max-height: 200px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 12px; background: white; margin-bottom: 0.5rem;">
                </div>

                <div id="selectedSkills"
                    style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; min-height: 40px; padding: 0.5rem; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px;">
                </div>

                <input type="hidden" name="skills" id="skillsInput" value="">
                <small class="help-text">Search and click to add skills. Click + to add custom ones.</small>
            </div>

            <!-- Education -->
            <div class="form-group">
                <label class="form-label" for="id_education">Education *</label>
                {{ form.education }}
                {% for error in form.education.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>

            <!-- Work Experience -->
            <div class="form-group">
                <label class="form-label" for="id_work_experience">Work Experience *</label>
                {{ form.work_experience }}
                {% for error in form.work_experience.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>

            <!-- Links -->
            <div class="form-group">
                <label class="form-label" for="id_links">Portfolio/LinkedIn URL</label>
                {{ form.links }}
                {% for error in form.links.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>

            {% if form.non_field_errors %}
            <div class="form-errors">
                {% for error in form.non_field_errors %}
                    <div class="error-message">{{ error }}</div>
                {% endfor %}
            </div>
            {% endif %}

            <button type="submit" class="signin-btn">
                <i class="fas fa-user-plus"></i> Create Account
            </button>
        </form>

        <div class="form-footer">
            <p>Are you a recruiter? <a href="{% url 'accounts:recruiter_signup' %}">Sign up here</a></p>
        </div>
    </div>
</div>

<!-- ✅ Safe JSON Embed -->
{{ skills|json_script:"available-skills" }}
<script id="selected-skills" type="application/json">[]</script>

<script>
const availableSkills = JSON.parse(document.getElementById('available-skills').textContent);
let selectedSkills = JSON.parse(document.getElementById('selected-skills').textContent);

const skillSearch = document.getElementById('skillSearch');
const skillDropdown = document.getElementById('skillDropdown');
const selectedSkillsDiv = document.getElementById('selectedSkills');
const skillsInput = document.getElementById('skillsInput');
const addSkillBtn = document.getElementById('addSkillBtn');

function filterSkills(searchText) {
    const filtered = availableSkills.filter(skill =>
        skill.name.toLowerCase().includes(searchText.toLowerCase()) &&
        !selectedSkills.find(s => s.id === skill.id)
    );
    skillDropdown.innerHTML = filtered.map(skill =>
        `<div class="skill-option" data-id="${skill.id}" data-name="${skill.name}">${skill.name}</div>`
    ).join('');
    skillDropdown.style.display = filtered.length ? 'block' : 'none';
}

function addSkill(id, name) {
    if (!selectedSkills.find(s => s.id === id)) {
        selectedSkills.push({ id, name });
        renderSelectedSkills();
        updateHiddenInput();
    }
    skillSearch.value = '';
    skillDropdown.style.display = 'none';
}

function removeSkill(id) {
    selectedSkills = selectedSkills.filter(s => s.id !== id);
    renderSelectedSkills();
    updateHiddenInput();
}

function renderSelectedSkills() {
    if (!selectedSkills.length) {
        selectedSkillsDiv.innerHTML = '<span style="color: var(--gray-400);">No skills selected yet</span>';
        return;
    }
    selectedSkillsDiv.innerHTML = selectedSkills.map(skill =>
        `<span class="skill-tag" style="display:inline-flex;align-items:center;gap:0.5rem;">
            ${skill.name}
            <button type="button" onclick="removeSkill(${skill.id})" style="background:none;border:none;color:var(--secondary-600);font-weight:bold;cursor:pointer;">×</button>
        </span>`
    ).join('');
}

function updateHiddenInput() {
    skillsInput.value = selectedSkills.map(s => s.id).join(',');
}

// --- Events ---
skillSearch.addEventListener('input', e => filterSkills(e.target.value));
skillDropdown.addEventListener('click', e => {
    if (e.target.classList.contains('skill-option')) {
        addSkill(parseInt(e.target.dataset.id), e.target.dataset.name);
    }
});
addSkillBtn.addEventListener('click', async () => {
    const skillName = skillSearch.value.trim();
    if (!skillName) return alert('Enter a skill name first');

    const existingSkill = availableSkills.find(s => s.name.toLowerCase() === skillName.toLowerCase());
    if (existingSkill) return addSkill(existingSkill.id, existingSkill.name);

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    try {
        const res = await fetch('/accounts/api/skills/create/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({ name: skillName })
        });
        if (res.ok) {
            const data = await res.json();
            availableSkills.push({ id: data.id, name: data.name });
            addSkill(data.id, data.name);
        } else {
            alert('Failed to add skill.');
        }
    } catch (err) {
        console.error('Error adding skill:', err);
    }
});
document.addEventListener('click', e => {
    if (!skillSearch.contains(e.target) && !skillDropdown.contains(e.target)) {
        skillDropdown.style.display = 'none';
    }
});
renderSelectedSkills();
updateHiddenInput();
</script>

<style>
.skill-option {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background 0.2s;
    border-bottom: 1px solid var(--gray-100);
    color: var(--gray-800);
}
.skill-option:hover {
    background: var(--primary-50);
    color: var(--gray-900);
}
.skill-option:last-child { border-bottom: none; }
</style>

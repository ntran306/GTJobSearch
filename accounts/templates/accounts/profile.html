{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block nav_profile %}active{% endblock %}

{% block content %}
<div class="container profile-page">
  <style>
    /* Tabs visibility */
    .tab-content { display: none !important; }
    .tab-content.active { display: block !important; }

    /* Tabs look */
    .tabs .tab-btn { padding: 8px 12px; border: 0; background: transparent; cursor: pointer; }
    .tabs .tab-btn.active { border-bottom: 2px solid currentColor; font-weight: 600; }
  </style>
  <!-- Profile Header -->
  <section class="profile-card profile-header">
    <div class="profile-avatar">
      <div class="avatar-placeholder">
        {% if profile and profile.profile_picture %}
          <img src="{{ profile.profile_picture.url }}" alt="{{ owner.username }}'s avatar" class="avatar-img">
        {% else %}
          <i class="fas fa-user"></i>
        {% endif %}
      </div>
    </div>

    <div class="profile-info">
      <h1 class="profile-name">{{ owner.username }}</h1>

      <p class="bio">
        {% if profile_type == "jobseeker" and profile.headline %}
          {{ profile.headline }}
        {% elif profile_type == "recruiter" %}
          Recruiter at {{ profile.company }}
        {% else %}
          Add a short description about yourself!
        {% endif %}
      </p>

      <p class="text-sm text-gray-600">
        <i class="fas fa-envelope"></i> {{ owner.email }}
      </p>
      <p class="text-sm text-gray-600">
        <i class="fas fa-calendar-alt"></i> Member since {{ owner.date_joined|date:"F Y" }}
      </p>

      {% if is_owner %}
        <a href="{% if profile_type == 'recruiter' %}
                    {% url 'accounts:edit_recruiter_profile' %}
                  {% else %}
                    {% url 'accounts:edit_profile' %}
                  {% endif %}"
           class="btn btn-primary btn-sm mt-2">
          Edit Profile
        </a>
      {% endif %}
    </div>
  </section>

  <!-- ==================== JOB SEEKER SECTIONS ==================== -->
  {% if profile_type == "jobseeker" %}
    <!-- Skills -->
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-tools"></i> Skills</h2>
      </div>
      <div class="section-content skills-display">
        {% if profile.skills.all %}
          {% for skill in profile.skills.all %}
            <span class="skill-tag">{{ skill.name }}</span>
          {% empty %}
            <p>No skills added yet.</p>
          {% endfor %}
        {% else %}
          <p>No skills added yet.</p>
        {% endif %}
      </div>
    </section>

    <!-- Education -->
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-graduation-cap"></i> Education</h2>
      </div>
      <div class="section-content">
        <p>{{ profile.education|linebreaks|default:"No education listed." }}</p>
      </div>
    </section>

    <!-- Work Experience -->
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-briefcase"></i> Work Experience</h2>
      </div>
      <div class="section-content">
        <p>{{ profile.work_experience|linebreaks|default:"No work experience added." }}</p>
      </div>
    </section>

    <!-- ✅ Location -->
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-map-marker-alt"></i> Location</h2>
      </div>
      <div class="section-content">
        <p>{{ profile.location|default:"No location listed." }}</p>
      </div>
    </section>

    <!-- ✅ Projects -->
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-project-diagram"></i> Projects</h2>
      </div>
      <div class="section-content">
        <p>{{ profile.projects|linebreaks|default:"No projects added yet." }}</p>
      </div>
    </section>

    <!-- Links -->
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-link"></i> Links</h2>
      </div>
      <div class="section-content">
        {% if profile.links %}
          <a href="{{ profile.links }}" target="_blank" class="profile-link">
            <i class="fas fa-external-link-alt"></i> {{ profile.links }}
          </a>
        {% else %}
          <p>No links provided.</p>
        {% endif %}
      </div>
    </section>

    <!-- Privacy Settings (only owner) -->
    {% if is_owner %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-user-shield"></i> Privacy Settings</h2>
      </div>
      <div class="section-content">
        <form method="post" action="{% url 'accounts:profile' %}" class="space-y-3">
          {% csrf_token %}

          <label class="privacy-option block">
            <input type="radio" name="privacy" value="public"
                   {% if profile.privacy == "public" %}checked{% endif %}>
            <strong>Public</strong><br>
            <span class="text-sm text-gray-600">
              Visible to all employers and job seekers.
            </span>
          </label>

          <label class="privacy-option block mt-3">
            <input type="radio" name="privacy" value="employers"
                   {% if profile.privacy == "employers" or profile.privacy == "employers_only" %}checked{% endif %}>
            <strong>Employers Only</strong><br>
            <span class="text-sm text-gray-600">
              Visible only to employers; they may contact you about opportunities.
            </span>
          </label>

          <label class="privacy-option block mt-3">
            <input type="radio" name="privacy" value="private"
                   {% if profile.privacy == "private" %}checked{% endif %}>
            <strong>Private</strong><br>
            <span class="text-sm text-gray-600">
              Hidden from others, but you can still apply for jobs.
            </span>
          </label>

          <button type="submit" class="btn btn-primary btn-sm mt-3">
            Save Privacy Settings
          </button>
        </form>
      </div>
    </section>
    {% endif %}
  {% endif %}

  <!-- ==================== CONTACT SECTION ==================== -->
  {% if can_email %}
  <section class="card profile-section">
    <div class="section-header">
      <h2><i class="fas fa-envelope"></i> Contact {{ owner.username }}</h2>
    </div>
    <div class="section-content">
      <form method="post" action="{% url 'accounts:contact_user' owner.id %}" class="contact-form" novalidate>
        {% csrf_token %}
        <div class="mb-3">
          <label for="contact-subject" class="form-label">Subject</label>
          <input id="contact-subject" name="subject" type="text" class="form-control" placeholder="Subject" required>
        </div>
        <div class="mb-3">
          <label for="contact-message" class="form-label">Message</label>
          <textarea id="contact-message" name="message" rows="6" class="form-control" placeholder="Write your message..." required></textarea>
        </div>
        <div class="flex gap-2 items-center">
          <button type="submit" class="btn btn-primary btn-sm">
            Send Email
          </button>
          <span class="text-sm text-gray-600">
            (We’ll deliver this to {{ owner.email }}.)
          </span>
        </div>
      </form>
    </div>
    <hr class="email-divider">
    <!-- Connect + Message actions -->
    <div class="mt-3 flex gap-2 items-center">
      {% if relation %}
        {% if relation.status == "accepted" %}
          <!-- Connected: Show Remove and Message buttons -->
          <form method="post" action="{% url 'communication:connections_remove' user_id=relation.other_id %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-outline btn-sm">Remove Connection</button>
          </form>
          
          <!-- NOW show Message button since they're connected -->
          <a href="{% url 'communication:start_conversation' user_id=owner.id %}"
            class="btn btn-secondary btn-sm js-open-chat"
            data-user-id="{{ owner.id }}"
            data-name="{{ owner.username }}">
            <i class="fas fa-comments"></i> Message
          </a>

        {% elif relation.status == "pending" and relation.incoming %}
          <!-- They sent you a request → Accept/Decline (no message yet) -->
          <form method="post" action="{% url 'communication:connections_accept' user_id=relation.other_id %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-success btn-sm">Accept</button>          
          </form>
          <form method="post" action="{% url 'communication:connections_decline' user_id=relation.other_id %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-outline btn-sm">Decline</button>          
          </form>

        {% elif relation.status == "pending" and relation.outgoing %}
          <!-- You already sent → waiting (no message yet) -->
          <button type="button" class="btn btn-outline btn-sm" disabled>
            <i class="fas fa-hourglass-half"></i> Request Sent
          </button>

        {% else %}
          <!-- Declined or unknown → show Connect again (no message) -->
          <form method="post"
                action="{% url 'communication:connections_request' user_id=owner.id %}"
                style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline btn-sm">
              <i class="fas fa-user-plus"></i> Connect
            </button>
          </form>
        {% endif %}
      {% else %}
        <!-- No relation exists yet → show Connect (no message) -->
        <form method="post"
              action="{% url 'communication:connections_request' user_id=owner.id %}"
              style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline btn-sm">
            <i class="fas fa-user-plus"></i> Connect
          </button>
        </form>
      {% endif %}
    </div>
    </div>
  </section>
  {% elif profile and owner.id != request.user.id %}
  <section class="card profile-section">
    <div class="section-header">
      <h2><i class="fas fa-envelope"></i> Contact</h2>
    </div>
    <div class="section-content">
      <p class="text-sm text-gray-600">This user can’t be contacted right now.</p>
    </div>
  </section>
  {% endif %}

  <!-- ==================== SAVED JOBS ==================== -->
  {% if profile_type == "jobseeker" and is_owner %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-bookmark"></i> Saved Jobs</h2>
      </div>
      <div class="section-content">
        {% if saved_jobs %}
          <ul>
            {% for job in saved_jobs %}
              <li>{{ job.title }} at {{ job.company }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p>You haven’t saved any jobs yet.</p>
        {% endif %}
      </div>
    </section>
  {% endif %}
  
  {% if is_owner %}
  <section class="card profile-section">
    <div class="section-header">
      <h2><i class="fas fa-users"></i> Connections</h2>
    </div>
    <div class="section-content">

      <!-- Tabs -->
      <div class="tabs mb-3 flex gap-3 border-b border-gray-300">
        <button id="tab-current" class="tab-btn active" type="button">
          <i class="fas fa-handshake"></i> Current
        </button>
        <button id="tab-pending" class="tab-btn" type="button">
          <i class="fas fa-clock"></i> Pending
        </button>
      </div>

      <!-- --- CURRENT CONNECTIONS --- -->
      <div id="tab-current-content" class="tab-content active">
        <div class="current-pending-box">
          {% if connections %}
            <ul class="connection-list">
              {% for conn in connections %}
                {% if conn.requester.id == request.user.id %}
                  {% with other=conn.addressee %}
                    {% url 'accounts:view_profile' other.id as other_profile_url %}
                    {% url 'communication:start_conversation' user_id=other.id as msg_url %}
                    {% url 'communication:connections_remove' user_id=other.id as remove_url %}

                    <li class="connection-item">
                      <div class="connection-main">
                        <div class="connection-avatar">
                          <div class="avatar-placeholder">
                            {% if other.jobseekerprofile and other.jobseekerprofile.profile_picture %}
                              <img src="{{ other.jobseekerprofile.profile_picture.url }}" class="avatar-img" alt="{{ other.username }}'s avatar">
                            {% elif other.recruiterprofile and other.recruiterprofile.profile_picture %}
                              <img src="{{ other.recruiterprofile.profile_picture.url }}" class="avatar-img" alt="{{ other.username }}'s avatar">
                            {% else %}
                              <i class="fas fa-user"></i>
                            {% endif %}
                          </div>
                        </div>

                        <div class="connection-info">
                          <a href="{{ other_profile_url }}" class="text-primary">{{ other.username }}</a>
                          <p class="connection-meta">
                            {% if other.jobseekerprofile %}
                              Job Seeker
                              {% if other.jobseekerprofile.headline %} · {{ other.jobseekerprofile.headline }}{% endif %}
                            {% elif other.recruiterprofile %}
                              Recruiter
                              {% if other.recruiterprofile.company %} · {{ other.recruiterprofile.company }}{% endif %}
                            {% else %}
                              User
                            {% endif %}
                          </p>
                        </div>
                      </div>

                      <div class="connection-actions flex gap-2">
                        <a href="{{ msg_url }}"
                           class="btn btn-secondary btn-sm js-open-chat"
                           data-user-id="{{ other.id }}"
                           data-name="{{ other.username }}">
                          <i class="fas fa-comments"></i> Message
                        </a>
                        <form method="post" action="{{ remove_url }}">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          <button type="submit" class="btn btn-outline btn-sm">Remove</button>
                        </form>
                      </div>
                    </li>
                  {% endwith %}
                {% else %}
                  {% with other=conn.requester %}
                    {% url 'accounts:view_profile' other.id as other_profile_url %}
                    {% url 'communication:start_conversation' user_id=other.id as msg_url %}
                    {% url 'communication:connections_remove' user_id=other.id as remove_url %}

                    <li class="connection-item">
                      <div class="connection-main">
                        <div class="connection-avatar">
                          <div class="avatar-placeholder">
                            {% if other.jobseekerprofile and other.jobseekerprofile.profile_picture %}
                              <img src="{{ other.jobseekerprofile.profile_picture.url }}" class="avatar-img" alt="{{ other.username }}'s avatar">
                            {% elif other.recruiterprofile and other.recruiterprofile.profile_picture %}
                              <img src="{{ other.recruiterprofile.profile_picture.url }}" class="avatar-img" alt="{{ other.username }}'s avatar">
                            {% else %}
                              <i class="fas fa-user"></i>
                            {% endif %}
                          </div>
                        </div>

                        <div class="connection-info">
                          <a href="{{ other_profile_url }}" class="text-primary">{{ other.username }}</a>
                          <p class="connection-meta">
                            {% if other.jobseekerprofile %}
                              Job Seeker
                              {% if other.jobseekerprofile.headline %} · {{ other.jobseekerprofile.headline }}{% endif %}
                            {% elif other.recruiterprofile %}
                              Recruiter
                              {% if other.recruiterprofile.company %} · {{ other.recruiterprofile.company }}{% endif %}
                            {% else %}
                              User
                            {% endif %}
                          </p>
                        </div>
                      </div>

                      <div class="connection-actions flex gap-2">
                        <a href="{{ msg_url }}"
                           class="btn btn-secondary btn-sm js-open-chat"
                           data-user-id="{{ other.id }}"
                           data-name="{{ other.username }}">
                          <i class="fas fa-comments"></i> Message
                        </a>
                        <form method="post" action="{{ remove_url }}">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          <button type="submit" class="btn btn-outline btn-sm">Remove</button>
                        </form>
                      </div>
                    </li>
                  {% endwith %}
                {% endif %}
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-sm text-gray-600">No current connections yet.</p>
          {% endif %}
        </div>
      </div>

      <!-- --- PENDING CONNECTIONS --- -->
      <div id="tab-pending-content" class="tab-content">
        <div class="current-pending-box">
          {% if pending_in or pending_out %}
            {% if pending_in %}
              <h4 class="font-semibold mb-2">Incoming Requests</h4>
              <ul class="connection-list mb-4">
                {% for conn in pending_in %}
                  {% with other=conn.requester %}
                    <li class="connection-item">
                      <div class="connection-main">
                        <div class="connection-avatar">
                          <div class="avatar-placeholder">
                            {% if other.jobseekerprofile and other.jobseekerprofile.profile_picture %}
                              <img src="{{ other.jobseekerprofile.profile_picture.url }}" class="avatar-img" alt="{{ other.username }}'s avatar">
                            {% elif other.recruiterprofile and other.recruiterprofile.profile_picture %}
                              <img src="{{ other.recruiterprofile.profile_picture.url }}" class="avatar-img" alt="{{ other.username }}'s avatar">
                            {% else %}
                              <i class="fas fa-user"></i>
                            {% endif %}
                          </div>
                        </div>

                        <div class="connection-info">
                          <a href="{% url 'accounts:view_profile' other.id %}" class="text-primary">
                            {{ other.username }}
                          </a>
                          <p class="connection-meta">
                            {% if other.jobseekerprofile %}
                              Job Seeker
                              {% if other.jobseekerprofile.headline %} · {{ other.jobseekerprofile.headline }}{% endif %}
                            {% elif other.recruiterprofile %}
                              Recruiter
                              {% if other.recruiterprofile.company %} · {{ other.recruiterprofile.company }}{% endif %}
                            {% else %}
                              User
                            {% endif %}
                          </p>
                        </div>
                      </div>

                      <div class="connection-actions flex gap-2">
                        <form method="post" action="{% url 'communication:connections_accept' user_id=other.id %}" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          <button type="submit" class="btn btn-success btn-sm">Accept</button>
                        </form>
                        <form method="post" action="{% url 'communication:connections_decline' user_id=other.id %}" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          <button type="submit" class="btn btn-outline btn-sm">Decline</button>
                        </form>
                      </div>
                    </li>
                  {% endwith %}
                {% endfor %}
              </ul>
            {% endif %}

            {% if pending_out %}
              <h4 class="font-semibold mb-2 {% if pending_in %}mt-4{% endif %}">Sent Requests</h4>
              <ul class="connection-list">
                {% for conn in pending_out %}
                  {% with other=conn.addressee %}
                    <li class="connection-item">
                      <div class="connection-main">
                        <div class="connection-avatar">
                          <div class="avatar-placeholder">
                            {% if other.jobseekerprofile and other.jobseekerprofile.profile_picture %}
                              <img src="{{ other.jobseekerprofile.profile_picture.url }}" class="avatar-img" alt="{{ other.username }}'s avatar">
                            {% elif other.recruiterprofile and other.recruiterprofile.profile_picture %}
                              <img src="{{ other.recruiterprofile.profile_picture.url }}" class="avatar-img" alt="{{ other.username }}'s avatar">
                            {% else %}
                              <i class="fas fa-user"></i>
                            {% endif %}
                          </div>
                        </div>

                        <div class="connection-info">
                          <a href="{% url 'accounts:view_profile' other.id %}" class="text-primary">
                            {{ other.username }}
                          </a>
                          <p class="connection-meta">
                            {% if other.jobseekerprofile %}
                              Job Seeker
                              {% if other.jobseekerprofile.headline %} · {{ other.jobseekerprofile.headline }}{% endif %}
                            {% elif other.recruiterprofile %}
                              Recruiter
                              {% if other.recruiterprofile.company %} · {{ other.recruiterprofile.company }}{% endif %}
                            {% else %}
                              User
                            {% endif %}
                          </p>
                        </div>
                      </div>

                      <span class="text-gray-500 text-sm">
                        <i class="fas fa-hourglass-half"></i> Pending...
                      </span>
                    </li>
                  {% endwith %}
                {% endfor %}
              </ul>
            {% endif %}
          {% else %}
            <p class="text-sm text-gray-600">No pending requests.</p>
          {% endif %}
        </div>
      </div>

    </div>
  </section>
{% endif %}

  <!-- ==================== RECRUITER SECTIONS ==================== -->
  {% if profile_type == "recruiter" %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-id-card"></i> Company/Recruiter Name</h2>
      </div>
      <div class="section-content">
        <p>{{ profile.name }}</p>
      </div>
    </section>

    {% if is_owner %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-rocket"></i> Quick Actions</h2>
      </div>
      <div class="section-content action-buttons">
        <a href="{% url 'jobs:create_job' %}" class="action-btn"><i class="fas fa-plus"></i> Post Job</a>
        <a href="{% url 'candidates:search_candidates' %}" class="action-btn"><i class="fas fa-search"></i> Browse Candidates</a>
      </div>
    </section>
    {% endif %}
  {% endif %}

</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const currentBtn = document.getElementById("tab-current");
  const pendingBtn = document.getElementById("tab-pending");
  const currentContent = document.getElementById("tab-current-content");
  const pendingContent = document.getElementById("tab-pending-content");

  if (!currentBtn || !pendingBtn || !currentContent || !pendingContent) return;

  function showCurrent() {
    currentBtn.classList.add("active");
    currentBtn.setAttribute("aria-selected", "true");
    pendingBtn.classList.remove("active");
    pendingBtn.setAttribute("aria-selected", "false");
    currentContent.classList.add("active");
    pendingContent.classList.remove("active");
  }

  function showPending() {
    pendingBtn.classList.add("active");
    pendingBtn.setAttribute("aria-selected", "true");
    currentBtn.classList.remove("active");
    currentBtn.setAttribute("aria-selected", "false");
    pendingContent.classList.add("active");
    currentContent.classList.remove("active");
  }

  currentBtn.addEventListener("click", showCurrent);
  pendingBtn.addEventListener("click", showPending);

  showCurrent();
});
</script>
{% endblock %}

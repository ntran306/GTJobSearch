{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block nav_profile %}active{% endblock %}

{% block content %}
<div class="container profile-page">

  <!-- Profile Header -->
  <section class="profile-card profile-header">
    <div class="profile-avatar">
      <div class="avatar-placeholder">
        <i class="fas fa-user"></i>
      </div>
      {% if is_owner %}
        <button class="btn btn-outline btn-sm">Upload Photo</button>
      {% endif %}
    </div>

    <div class="profile-info">
      <!-- Use the profile owner, not the logged-in user -->
      <h1 class="profile-name">{{ owner.username }}</h1>

      <p class="bio">
        {% if profile_type == "jobseeker" and profile.headline %}
          {{ profile.headline }}
        {% elif profile_type == "recruiter" %}
          Recruiter at {{ profile.company }}
        {% else %}
          Add a short description about yourself!
        {% endif %}
      </p>

      <p class="text-sm text-gray-600">
        <i class="fas fa-envelope"></i> {{ owner.email }}
      </p>
      <p class="text-sm text-gray-600">
        <i class="fas fa-calendar-alt"></i> Member since {{ owner.date_joined|date:"F Y" }}
      </p>

      {% if is_owner %}
        <a href="{% if profile_type == 'recruiter' %}
                    {% url 'accounts:edit_recruiter_profile' %}
                  {% else %}
                    {% url 'accounts:edit_profile' %}
                  {% endif %}"
           class="btn btn-primary btn-sm">
          Edit Profile
        </a>
      {% endif %}
    </div>
  </section>

  <!-- Jobseeker-specific sections -->
  {% if profile_type == "jobseeker" %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-tools"></i> Skills</h2>
      </div>
      <div class="section-content skills-display">
        {% if profile.skills %}
          {% for skill in profile.skills|split:"," %}
            <span class="skill-tag">{{ skill }}</span>
          {% endfor %}
        {% else %}
          <p>No skills added yet.</p>
        {% endif %}
      </div>
    </section>

    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-graduation-cap"></i> Education</h2>
      </div>
      <div class="section-content">
        <p>{{ profile.education|linebreaks|default:"No education listed." }}</p>
      </div>
    </section>

    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-briefcase"></i> Work Experience</h2>
      </div>
      <div class="section-content">
        <p>{{ profile.work_experience|linebreaks|default:"No work experience added." }}</p>
      </div>
    </section>

    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-link"></i> Links</h2>
      </div>
      <div class="section-content">
        {% if profile.links %}
          <a href="{{ profile.links }}" target="_blank" class="profile-link">
            <i class="fas fa-external-link-alt"></i> {{ profile.links }}
          </a>
        {% else %}
          <p>No links provided</p>
        {% endif %}
      </div>
    </section>

    <!-- Privacy Settings: only when you're viewing your own profile -->
    {% if is_owner %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-user-shield"></i> Privacy Settings</h2>
      </div>
      <div class="section-content">
        <form method="post" action="{% url 'accounts:profile' %}" class="space-y-3">
          {% csrf_token %}

          <label class="privacy-option block">
            <input type="radio" name="privacy" value="public"
                   {% if profile.privacy == "public" %}checked{% endif %}>
            <strong>Public</strong><br>
            <span class="text-sm text-gray-600">
              You'll be visible to all employers and job seekers and can receive messages from everyone.
            </span>
          </label>

          <label class="privacy-option block mt-3">
            <input type="radio" name="privacy" value="employers"
                   {% if profile.privacy == 'employers' or profile.privacy == 'employers_only' %}checked{% endif %}
            <strong>Employers</strong><br>
            <span class="text-sm text-gray-600">
              Your profile will be visible to employers. You may receive messages about opportunities.
            </span>
          </label>

          <label class="privacy-option block mt-3">
            <input type="radio" name="privacy" value="private"
                   {% if profile.privacy == "private" %}checked{% endif %}>
            <strong>Private</strong><br>
            <span class="text-sm text-gray-600">
              You can apply for jobs, but employers cannot message you directly.
            </span>
          </label>

          <button type="submit" class="btn btn-primary btn-sm mt-3">
            Save Privacy Settings
          </button>
        </form>
      </div>
    </section>
    {% endif %}
  {% endif %}

  <!-- Email Contact Form Section -->
  {% if can_email %}
  <section class="card profile-section">
    <div class="section-header">
      <h2><i class="fas fa-envelope"></i> Contact {{ owner.username }}</h2>
    </div>
    <div class="section-content">
      <form method="post"
            action="{% url 'accounts:contact_user' owner.id %}"
            class="contact-form"
            novalidate>
        {% csrf_token %}

        <div class="mb-3">
          <label for="contact-subject" class="form-label">Subject</label>
          <input id="contact-subject"
                 name="subject"
                 type="text"
                 class="form-control"
                 placeholder="Subject"
                 required>
        </div>

        <div class="mb-3">
          <label for="contact-message" class="form-label">Message</label>
          <textarea id="contact-message"
                    name="message"
                    rows="6"
                    class="form-control"
                    placeholder="Write your message..."
                    required></textarea>
        </div>

        <div class="flex gap-2 items-center">
          <button type="submit" class="btn btn-primary btn-sm">
            Send Email
          </button>
          <span class="text-sm text-gray-600">
            We’ll deliver this to {{ owner.email }}.
          </span>
        </div>
      </form>
    </div>
  </section>
  {% elif profile and owner.id != request.user.id %}
  <section class="card profile-section">
    <div class="section-header">
      <h2><i class="fas fa-envelope"></i> Contact</h2>
    </div>
    <div class="section-content">
      <p class="text-sm text-gray-600">This user can’t be contacted right now.</p>
    </div>
  </section>
  {% endif %}

  <!-- Saved Jobs Section (your own page only) -->
  {% if profile_type == "jobseeker" and is_owner %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-bookmark"></i> Saved Jobs</h2>
      </div>
      <div class="section-content">
        {% if saved_jobs %}
          <ul>
            {% for job in saved_jobs %}
              <li>{{ job.title }} at {{ job.company }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p>You haven’t saved any jobs yet.</p>
        {% endif %}
      </div>
    </section>
  {% endif %}

  <!-- Recruiter-specific sections -->
  {% if profile_type == "recruiter" %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-id-card"></i> Company/Recruiter Name</h2>
      </div>
      <div class="section-content">
        <p>{{ profile.name }}</p>
      </div>
    </section>

    {% if is_owner %}
    <section class="card profile-section">
      <div class="section-header">
        <h2><i class="fas fa-rocket"></i> Quick Actions</h2>
      </div>
      <div class="section-content action-buttons">
        <a href="{% url 'jobs:create_job' %}" class="action-btn"><i class="fas fa-plus"></i> Post Job</a>
        <a href="{% url 'candidates:search_candidates' %}" class="action-btn">Browse Candidates</a>
      </div>
    </section>
    {% endif %}
  {% endif %}

</div>
{% endblock %}